{% extends "base.html" %}

{% block title %}Оценка сплетни - {{ gossip.title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="rating-page">
        <!-- Заголовок -->
        <div class="rating-header">
            <h1><i class="fas fa-star"></i> Оценка сплетни</h1>
            <p class="rating-subtitle">Как модератор, оцените качество этой сплетни</p>
        </div>

        <!-- Информация о сплетне -->
        <div class="gossip-preview">
            <div class="gossip-card">
                <h2 class="gossip-title">{{ gossip.title }}</h2>
                <div class="gossip-meta">
                    <span class="meta-item">
                        <i class="fas fa-user"></i>
                        <a href="{{ url_for('profile', username=gossip.author.username) }}">{{ gossip.author.username }}</a>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-clock"></i>
                        <time datetime="{{ gossip.date_posted.isoformat() }}Z">{{ gossip.date_posted.strftime('%Y-%m-%d %H:%M') }}</time>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-comments"></i>
                        {{ gossip.comments|length }} комментариев
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-heart"></i>
                        {{ gossip.likes|length }} лайков
                    </span>
                </div>
                <div class="gossip-content">
                    {{ gossip.content_html|safe if gossip.content_html else gossip.content|replace('\n', '<br>')|safe }}
                </div>
            </div>
        </div>

        <!-- Форма оценки -->
        <div class="rating-form-container">
            <form method="POST" class="rating-form">
                {{ form.csrf_token }}
                
                <div class="rating-section">
                    <h3><i class="fas fa-star"></i> Ваша оценка</h3>
                    <p class="rating-description">Оцените сплетню по шкале от 1 до 10, где 10 - отличное качество</p>
                    
                    <div class="rating-stars">
                        {% for i in range(1, 11) %}
                        <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" 
                               {% if existing_rating and existing_rating.rating == i %}checked{% endif %}
                               class="star-input">
                        <label for="star{{ i }}" class="star-label">
                            <i class="fas fa-star"></i>
                            <span class="star-number">{{ i }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    
                    <div class="rating-value-display">
                        <span id="current-rating">
                            {% if existing_rating %}
                                {{ existing_rating.rating }}/10
                            {% else %}
                                Выберите оценку
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="comment-section">
                    <h3><i class="fas fa-comment"></i> Пояснение к оценке</h3>
                    <p class="comment-description">Опишите, почему вы поставили такую оценку (необязательно)</p>
                    
                    <textarea name="comment" id="rating-comment" class="form-control" rows="4" 
                              placeholder="Например: Отличная структура, интересная история, хороший стиль написания...">{{ existing_rating.comment if existing_rating else '' }}</textarea>
                </div>

                <div class="rating-actions">
                    <a href="{{ url_for('gossip', gossip_id=gossip.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Назад к сплетне
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        {% if existing_rating %}
                            Обновить оценку
                        {% else %}
                            Отправить оценку
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>

        <!-- Существующие оценки -->
        {% if gossip.moderator_ratings %}
        <div class="existing-ratings">
            <h3><i class="fas fa-chart-bar"></i> Оценки других модераторов</h3>
            <div class="ratings-summary">
                <div class="avg-rating">
                    <span class="avg-number">{{ "%.1f"|format(gossip.moderator_ratings|map(attribute='rating')|sum / gossip.moderator_ratings|length) }}</span>
                    <span class="avg-label">средняя оценка</span>
                </div>
                <div class="ratings-count">
                    <span class="count-number">{{ gossip.moderator_ratings|length }}</span>
                    <span class="count-label">оценок</span>
                </div>
            </div>
            
            <div class="ratings-list">
                {% for rating in gossip.moderator_ratings %}
                <div class="rating-item">
                    <div class="rating-header">
                        <div class="moderator-info">
                            <a href="{{ url_for('profile', username=rating.moderator.username) }}" class="moderator-name">
                                {{ rating.moderator.username }}
                            </a>
                            <span class="moderator-badge">Модератор</span>
                        </div>
                        <div class="rating-score">
                            <span class="score">{{ rating.rating }}/10</span>
                            <div class="score-stars">
                                {% for i in range(1, 11) %}
                                <i class="fas fa-star {% if i <= rating.rating %}filled{% endif %}"></i>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% if rating.comment %}
                    <div class="rating-comment">
                        <p>{{ rating.comment }}</p>
                    </div>
                    {% endif %}
                    <div class="rating-date">
                        <i class="fas fa-clock"></i>
                        {{ rating.rated_at.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.rating-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 0;
}

.rating-header {
    text-align: center;
    margin-bottom: 2rem;
}

.rating-header h1 {
    color: var(--text-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.rating-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
}

.gossip-preview {
    margin-bottom: 2rem;
}

.gossip-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
}

.gossip-title {
    color: var(--text-color);
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.gossip-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.meta-item a {
    color: var(--accent-color);
    text-decoration: none;
}

.gossip-content {
    color: var(--text-color);
    line-height: 1.6;
}

.rating-form-container {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
    margin-bottom: 2rem;
}

.rating-section, .comment-section {
    margin-bottom: 2rem;
}

.rating-section h3, .comment-section h3 {
    color: var(--text-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.rating-description, .comment-description {
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.rating-stars {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.star-input {
    display: none;
}

.star-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--bg-color);
    min-width: 60px;
}

.star-label:hover {
    border-color: var(--accent-color);
    transform: translateY(-2px);
}

.star-label i {
    font-size: 1.5rem;
    color: #ffd700;
}

.star-number {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 600;
}

.star-input:checked + .star-label {
    border-color: var(--accent-color);
    background: var(--accent-color);
    color: white;
}

.star-input:checked + .star-label i,
.star-input:checked + .star-label .star-number {
    color: white;
}

.rating-value-display {
    text-align: center;
    padding: 1rem;
    background: var(--bg-color);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

#current-rating {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent-color);
}

#rating-comment {
    width: 100%;
    resize: vertical;
    min-height: 100px;
}

.rating-actions {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.existing-ratings {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
}

.existing-ratings h3 {
    color: var(--text-color);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ratings-summary {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--bg-color);
    border-radius: 8px;
}

.avg-rating, .ratings-count {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
}

.avg-number, .count-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-color);
}

.avg-label, .count-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.ratings-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.rating-item {
    background: var(--bg-color);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid var(--border-color);
}

.rating-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.moderator-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.moderator-name {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
}

.moderator-badge {
    background: var(--accent-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.rating-score {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.score {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent-color);
}

.score-stars {
    display: flex;
    gap: 0.1rem;
}

.score-stars i {
    font-size: 0.8rem;
    color: #ddd;
}

.score-stars i.filled {
    color: #ffd700;
}

.rating-comment {
    margin: 0.5rem 0;
    padding: 0.5rem;
    background: var(--card-bg);
    border-radius: 4px;
    border-left: 3px solid var(--accent-color);
}

.rating-comment p {
    margin: 0;
    color: var(--text-color);
    font-style: italic;
}

.rating-date {
    font-size: 0.8rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

@media (max-width: 768px) {
    .rating-page {
        padding: 1rem;
    }
    
    .rating-stars {
        justify-content: center;
    }
    
    .star-label {
        min-width: 50px;
        padding: 0.5rem;
    }
    
    .rating-actions {
        flex-direction: column;
        gap: 1rem;
    }
    
    .ratings-summary {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .rating-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const starInputs = document.querySelectorAll('.star-input');
    const currentRating = document.getElementById('current-rating');
    
    starInputs.forEach(input => {
        input.addEventListener('change', function() {
            const rating = this.value;
            currentRating.textContent = `${rating}/10`;
        });
    });
});
</script>
{% endblock %}
